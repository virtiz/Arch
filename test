#!/bin/sh -e

######Define Vairables#####
fdisk -l
echo -n "What drive do you want to install on? ie: /dev/vda "
read device

####Partition Drive####
sudo parted $device mklabel gpt
sudo parted $device mkpart ESP fat32 1MiB 513MiB
sudo parted $device set 1 boot on
sudo parted $device name 1 efi
sudo parted $device mkpart primary 513MiB 800MiB
sudo parted $device name 2 boot
sudo parted $device mkpart primary 800MiB 100%
sudo parted $device name 3 lvm
sudo parted $device set 3 lvm on
lvmdevice=`sudo fdisk -l $device | grep LVM | awk '{print $1}'`
efidevice=`sudo fdisk -l $device | grep EFI | awk '{print $1}'`
bootdevice=`sudo fdisk -l $device | grep filesystem | awk '{print $1}'`
pvcreate $lvmdevice
vgcreate lvm lvmdevice
lvcreate -n root -L 50G lvm
lvcreate -n swap -L 32G lvm
lvcreate -n home -l 100%FREE lvm
mkfs.fat -F32 $efidevice
mkfs.ext2 $bootdevice
mkfs.btrfs -L root /dev/lvm/root
mkfs.btrfs -L home /dev/lvm/home
mkswap /dev/lvm/swap
swapon /dev/lvm/swap
mount /dev/lvm/root /mnt
mkdir /mnt/{home,boot}
mount $bootdevice /mnt/boot
mkdir /mnt/boot/efi
mount $efidevice /mnt/boot/efi
mount /dev/lvm/home /mnt/home

####Setup Configs####
pacstrap /mnt base base-devel linux linux-firmware grub efibootmgr vim btrfs-progs --noconfirm
genfstab -U -p /mnt > /mnt/etc/fstab

#Function Buildout
Buildout(){

#Ask Questions
echo -n "What username would you like? "
read username
echo -n "What HostName would you like? "
read hostname
echo -n "what is your locale?  ex: America/Phoenix "
read locale

lang="en_US.UTF-8"
locale="en_US.UTF-8 UTF-8"


#Set information for devices/timezones
echo $hostname > /etc/hostname
ln -s /usr/share/zoneinfo/$countrycode/$timezone /etc/localtime
echo "LANG=$lang" >> /etc/locale.conf
sed -i "/$locale/s/^#//" /etc/locale.gen
locale-gen
hwclock --systohc

#Set Passwords
echo "Password for root"
passwd root
useradd -m -g users -G wheel $username
echo "Password for "$username
passwd $username

#Install base softwares
sudo pacman -Sy && sudo pacman -S networkmanager neovim lvm2 sudo brave openssh --noconfirm

#Correct hooks to add lvm2
sed -i '/HOOKS=(base udev autodetect modconf block filesystems keyboard fsck)/s/^/HOOKS=(base udev autodetect modconf block lvm2 filesystems keyboard fsck)'/ /etc/mkinitcpio.conf

#Grub install
grub-install --target=x86_64-efi --efi-directory=/boot/efi
grub-mkconfig -o /boot/grub/grub.cfg
mkinitcpio -p linux

#Give users with Wheel sudo access
sed -i '/^# %wheel ALL=(ALL) ALL/s/^# //' /etc/sudoers

#Enable Services
systemctl enable {sshd,NetworkManager}
}
#Finish funtion
export -f Buildout

#Enter arch-chroot and run function
arch-chroot /mnt /bin/bash -c "Buildout"
echo "you can reboot now"

